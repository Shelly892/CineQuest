# Frontend
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: cinequest
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
        - name: frontend
          image: zeli8888/cinequest-frontend
          ports:
            - containerPort: 80
          env:
            - name: GATEWAY_URL
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: GATEWAY_URL
---
apiVersion: v1
kind: Service
metadata:
  name: frontend
  namespace: cinequest
spec:
  type: NodePort
  selector:
    app: frontend
  ports:
    - port: 80
      targetPort: 80
      nodePort: 30000
---
# Gateway
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway
  namespace: cinequest
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gateway
  template:
    metadata:
      labels:
        app: gateway
    spec:
      containers:
        - name: gateway
          image: zeli8888/cinequest-gateway
          ports:
            - containerPort: 8000
          env:
            - name: KEYCLOAK_SERVICE_URL
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: KEYCLOAK_SERVICE_URL
            - name: MOVIE_SERVICE_URL
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: MOVIE_SERVICE_URL
            - name: RATING_SERVICE_URL
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: RATING_SERVICE_URL
            - name: SIGN_SERVICE_URL
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: SIGN_SERVICE_URL
            - name: ACHIEVEMENT_SERVICE_URL
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: ACHIEVEMENT_SERVICE_URL
            - name: NOTIFICATION_SERVICE_URL
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: NOTIFICATION_SERVICE_URL
            - name: JWT_SET_URL
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: JWT_SET_URL
---
apiVersion: v1
kind: Service
metadata:
  name: gateway
  namespace: cinequest
spec:
  selector:
    app: gateway
  ports:
    - port: 8000
      targetPort: 8000
---
# Movie Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: movie-service
  namespace: cinequest
spec:
  replicas: 1
  selector:
    matchLabels:
      app: movie-service
  template:
    metadata:
      labels:
        app: movie-service
    spec:
      containers:
        - name: movie-service
          image: zeli8888/cinequest-movie-service
          ports:
            - containerPort: 3002
          env:
            - name: TMDB_API_KEY
              valueFrom:
                secretKeyRef:
                  name: tmdb-secrets
                  key: tmdb-api-key
            - name: MOVIE_REDIS_HOST
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: MOVIE_REDIS_HOST
---
apiVersion: v1
kind: Service
metadata:
  name: movie-service
  namespace: cinequest
spec:
  selector:
    app: movie-service
  ports:
    - port: 3002
      targetPort: 3002
---
# Rating Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rating-service
  namespace: cinequest
spec:
  replicas: 1
  selector:
    matchLabels:
      app: rating-service
  template:
    metadata:
      labels:
        app: rating-service
    spec:
      containers:
        - name: rating-service
          image: zeli8888/cinequest-rating-service
          ports:
            - containerPort: 3003
          env:
            - name: RATING_MONGODB_URI
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: RATING_MONGODB_URI
            - name: ACHIEVEMENT_GRPC_URI
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: ACHIEVEMENT_GRPC_URI
---
apiVersion: v1
kind: Service
metadata:
  name: rating-service
  namespace: cinequest
spec:
  selector:
    app: rating-service
  ports:
    - port: 3003
      targetPort: 3003
---
# Sign Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sign-service
  namespace: cinequest
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sign-service
  template:
    metadata:
      labels:
        app: sign-service
    spec:
      containers:
        - name: sign-service
          image: zeli8888/cinequest-sign-service
          ports:
            - containerPort: 3004
          env:
            - name: SIGN_POSTGRES_URI
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: SIGN_POSTGRES_URI
            - name: SIGN_POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: database-secrets
                  key: postgres-user
            - name: SIGN_POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: database-secrets
                  key: postgres-password
            - name: ACHIEVEMENT_GRPC_URI
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: ACHIEVEMENT_GRPC_URI
---
apiVersion: v1
kind: Service
metadata:
  name: sign-service
  namespace: cinequest
spec:
  selector:
    app: sign-service
  ports:
    - port: 3004
      targetPort: 3004
---
# Achievement Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: achievement-service
  namespace: cinequest
spec:
  replicas: 1
  selector:
    matchLabels:
      app: achievement-service
  template:
    metadata:
      labels:
        app: achievement-service
    spec:
      containers:
        - name: achievement-service
          image: zeli8888/cinequest-achievement-service
          ports:
            - containerPort: 3005
            - containerPort: 50051
          env:
            - name: ACHIEVEMENT_MONGODB_URI
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: ACHIEVEMENT_MONGODB_URI
            - name: KAFKA_BOOTSTRAP_SERVERS
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: KAFKA_BOOTSTRAP_SERVERS
            - name: KAFKA_SCHEMA_REGISTRY_URL
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: KAFKA_SCHEMA_REGISTRY_URL
---
apiVersion: v1
kind: Service
metadata:
  name: achievement-service
  namespace: cinequest
spec:
  selector:
    app: achievement-service
  ports:
    - name: http
      port: 3005
      targetPort: 3005
    - name: grpc
      port: 50051
      targetPort: 50051
---
# Notification Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: notification-service
  namespace: cinequest
spec:
  replicas: 1
  selector:
    matchLabels:
      app: notification-service
  template:
    metadata:
      labels:
        app: notification-service
    spec:
      containers:
        - name: notification-service
          image: zeli8888/cinequest-notification-service
          ports:
            - containerPort: 3006
          env:
            - name: MAILTRAP_HOST
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: MAILTRAP_HOST
            - name: MAILTRAP_PORT
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: MAILTRAP_PORT
            - name: MAILTRAP_USERNAME
              valueFrom:
                secretKeyRef:
                  name: mailtrap-secrets
                  key: mailtrap-username
            - name: MAILTRAP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mailtrap-secrets
                  key: mailtrap-password
            - name: KAFKA_BOOTSTRAP_SERVERS
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: KAFKA_BOOTSTRAP_SERVERS
            - name: SCHEMA_REGISTRY_URL
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: KAFKA_SCHEMA_REGISTRY_URL
---
apiVersion: v1
kind: Service
metadata:
  name: notification-service
  namespace: cinequest
spec:
  selector:
    app: notification-service
  ports:
    - port: 3006
      targetPort: 3006
